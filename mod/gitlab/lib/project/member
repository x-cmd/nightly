# shellcheck shell=sh
# shellcheck disable=SC2039,3043

# gitlab project member +el:admin -user-a +user-b
# shellcheck disable=SC2154,SC2086
___x_cmd_gitlab_project_member(){
    param:subcmd ___x_cmd_gitlab_project_member         \
        ls              "List project member"           \
        user            "Show project member user info" \
        add             "Add project member"            \
        rm              "Remove member"
    param:subcmd:try
    param:run

    ___x_cmd_gitlab_project_member _param_help_doc
    gitlab_log warn "Subcmd Not Found."
    return 1
}
___x_cmd_gitlab_project_member_ls(){
    param:scope     ___x_cmd_gitlab
    param:dsl       '
options:
    #1|--id         "The ID or URL-encoded path of the project."    <>
    --search        "Search for specific users."                    <>=""
    --skip_users    "Filter out users with the specified ID."      <>:integer_array=""
'
 param:run
   ___gitlab_ui_mutual ___x_cmd_gitlab_get_multi "/projects/$id/users" <<A
        ___ui_table_json Id=.id Username=.username web_url=.web_url State=.state -- \$@
A
}

___x_cmd_gitlab_project_member_user(){
    param:scope     ___x_cmd_gitlab
    param:dsl      '
options:
    #1|--id         "The ID or URL-encoded path of the group."  <>
    --user_id       "The user ID of the member"                 <>:UserName
'
    param:run

    ___x_cmd_gitlab_http get "/project/$id/members/$user_id" | \
    {
        ___x_cmd_git_json_query_rename username=.username url=.web_url email=.email
        if [ -n "$username" ]; then
             ___x_cmd_ui_tf true  "Success" "username: $username" "url: $url" "email: $email"
             return 0
        else
            ___x_cmd_ui_tf false "Couldn't find any data by  $user_id in project $id"
            return 1
        fi
    }
}

# shellcheck disable=SC2181,SC2154
# https://gitee.com/api/swagger#/putV5projectsOwnerprojectCollaboratorsUsername
___x_cmd_gitlab_project_member_add(){
    param:scope     ___x_cmd_gitlab
    param:dsl       '
options:
    --project|-r           "Provide owner name and project name.(default:the current user project)"   <>:projectName
    --permission|-p     "permission"                                                         <>:projectPerm="push"
    #n                  "Username list"                                                      <>
'
    param:run

    # param Design permission:key
    ___x_cmd_gitlab_param_init_owner_project
    if [ -z "$1" ];then
        gitlab_log error "At least one user's spatial address is needed, gitlab member add <user>"
        return 1
    fi

    local username
    for username in "$@"; do
        ___x_cmd_gitlab_http put json "/projects/$owner_project/collaborators/${username##*/}" permission | \
            ___x_cmd_gitlab_project_member_add_json_status_handler
    done
}

___x_cmd_gitlab_project_member_add_json_status_handler(){
    if [ ! -t 1 ] || [ -n "$ENFORCE_JSON" ]; then
        cat
        return
    fi

    ___x_cmd_git_json_query_rename id=.id
    if [ -n "$id" ]; then
        ___x_cmd_ui_tf true  "Add $username to $owner_project successfully"
        return 0
    else
        ___x_cmd_ui_tf false "Add user failure: $username to $owner_project"
        return 1
    fi
}

# shellcheck disable=SC2181
# https://gitee.com/api/swagger#/deleteV5projectsOwnerprojectCollaboratorsUsername
___x_cmd_gitlab_project_member_rm(){
    param:scope     ___x_cmd_gitlab
    param:dsl       '
options:
    --project|-r       "Provide owner name and project name.(default:the current user project)"   <>:projectName
    #n              "Username list"
'
    param:run
    [ -z "$1" ] && gitlab_log error "At least one user's spatial address is needed" && return 1

    ___x_cmd_gitlab_param_init_owner_project

    local username
    for username in "$@"; do
        # TODO:http handleï¼Œdelete project return data is null.Status: 204 No Content
        if ___x_cmd_gitlab_http delete "/projects/$owner_project/collaborators/${username##*/}" >/dev/null; then
            ___x_cmd_ui_tf true  "Remove $username to $owner_project successfully"
        else
            ___x_cmd_ui_tf false "Remove user failure: $username"
            return 1
        fi
    done
}
