# shellcheck shell=sh
# shellcheck disable=SC2039,3043

# Should be like this.
# gh repo member add el:admin
# gh repo member remove user-a
# gh repo member add user-b

# gh repo member +el:admin -user-a +user-b
___x_cmd_gh_repo_member(){
    param:dsl       '
subcmd:
    ls              "list member"
    add             "add member"
    rm              "Remove member"
'
    param:run

    if [ -z "$PARAM_SUBCMD" ]; then
        gh_log error "subcommand not found. show help."
        return 0
    fi

    "___x_cmd_gh_repo_member_$PARAM_SUBCMD" "$@"
}
# Section: List
___x_cmd_gh_repo_member_ls() {
    param:scope     "github/$O"
    param:dsl       '
type:
    Affiliation =   outside direct all
options:
    --affiliation   "Filter collaborators returned by their affiliation."               <>:Affiliation="all"
    --per_page      "Results per page"                                                  <>=30
    --page          "Page number of the results to fetch."                              <>=1
    #1|--repo       "Provide owner name and repo name.(default:the current user repo)"  <>:repo
'
    param:run
    ___x_cmd_gh_param_init_owner_repo

    if ___ui_table_json Id=.id Owner=.login Url=.html_url \
        -- "___x_cmd_gh_get_multi" "/repos/${owner_repo}/collaborators" per_page page; then
        return 0
    fi
}
# EndSection

# Section: Add & Rm
___x_cmd_gh_repo_member_add() {
    param:scope     "github/$O"
    param:dsl       '
options:
    --repo          "Provide owner name and repo name.(default:the current user repo)"      <>:repo
    --permission    "The permission to grant the collaborator."                             <>:permission=push
    --permissions   "permissions"                                                           <>=""
    #n              "Username list"                                                         <>
'
    param:run

    ___x_cmd_gh_param_init_owner_repo
    if [ $# -eq 0 ];then
        printf "%s\n" "At least one user's spatial address is needed"
        return 1
    fi
    local username
    for username in "$@"; do
        {
            ___x_cmd_gh_put_json "/repos/$owner_repo/collaborators/${username##*/}" permission | (
            data=___x_cmd_git_json_query .full_name
            if [ -n "$data" ];then
                ui tf "true" "add $username to $owner_repo successfully"
            else
                gh_log error "add user failure: $username."
                return 1
            fi
            )
        }
    done
}

___x_cmd_gh_repo_member_rm() {
    param:scope     "github/$O"
    param:dsl       '
options:
    --repo      "Provide owner name and repo name.(default:the current user repo)"  <>:repo
    #n          "Username list"
'
    param:run
    if [ $# -eq 0 ];then
        gh_log error "At least one user's spatial address is needed"
        return 1
    fi

    ___x_cmd_gh_param_init_owner_repo
    local username
    for username in "$@"; do
        # TODO:http handleï¼Œdelete repo return data is null.Status: 204 No Content
        if ___x_cmd_gh_delete "/repos/$owner_repo/collaborators/${username##*/}";then
            ___x_cmd_ui_tf true  "successfully deleted $username in $owner_repo"
        else
            ___x_cmd_ui_tf false "delete user failure: $username."
            return 1
        fi
    done
}
# EndSection
